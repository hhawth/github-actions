name: Deploy (GCP Artifact Registry)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: false
        default: 'latest'
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'requirements.txt'
      - 'api_server.py'
      - 'unified_betting_app.py'
      - 'quantitative_betting_workflow.py'
      - 'src/**'
      - 'duckdb/**'
      - '.github/workflows/deploy-gcloud.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.GOOGLE_PROJECT }}" ]; then
            echo "Error: GOOGLE_PROJECT secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" ]; then
            echo "Error: GOOGLE_APPLICATION_CREDENTIALS secret is not set"
            exit 1
          fi
          echo "âœ“ Required secrets are present"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GOOGLE_PROJECT }}
          export_default_credentials: true

      - name: Set gcloud project
        run: gcloud config set project ${{ secrets.GOOGLE_PROJECT }}

      - name: Configure Docker auth
        run: |
          gcloud auth configure-docker europe-west2-docker.pkg.dev -q

      - name: Validate Artifact Registry repository
        run: |
          gcloud artifacts repositories describe demo --location=europe-west2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        env:
          GOOGLE_PROJECT: ${{ secrets.GOOGLE_PROJECT }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
          DOCKER_BUILDKIT: 1
        run: |
          docker buildx build \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max \
            --platform=linux/amd64 \
            --push \
            --tag europe-west2-docker.pkg.dev/$GOOGLE_PROJECT/demo/slim:${IMAGE_TAG} .

      - name: Deploy to Cloud Run
        env:
          GOOGLE_PROJECT: ${{ secrets.GOOGLE_PROJECT }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
        run: |
          gcloud run deploy betting-api \
            --image europe-west2-docker.pkg.dev/$GOOGLE_PROJECT/demo/slim:${IMAGE_TAG} \
            --region europe-west2 \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 2Gi \
            --cpu 1 \
            --set-env-vars "PORT=8080" \
            --set-secrets "API_FOOTBALL_KEY=api-football-key:latest,MATCHBOOK_USERNAME=matchbook-username:latest,MATCHBOOK_PASSWORD=matchbook-password:latest" \
            --max-instances 3 \
            --min-instances 0 \
            --timeout 300
